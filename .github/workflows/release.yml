name: release-please

on:
  push:
    branches: [main]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  release:
    runs-on: ubuntu-latest
    outputs:
      releases_created: ${{ steps.rp.outputs.releases_created }}
      paths_released: ${{ steps.rp.outputs.paths_released }}
    steps:
      - id: rp
        uses: googleapis/release-please-action@v4
        with:
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json

  deploy:
    needs: release
    if: ${{ needs.release.outputs.releases_created == 'true' }}
    runs-on: ubuntu-latest
    container: ghcr.io/railwayapp/cli:latest
    env:
      RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
    steps:
      - uses: actions/checkout@v5

      # Deploy API only if apps/api was released
      - name: Deploy API
        if: ${{ contains(fromJSON(needs.release.outputs.paths_released), 'apps/api') }}
        env:
          SVC_ID: a65fd5b6-b21d-4a55-a1bd-e7afe2260669
        run: railway up -s ${{ env.SVC_ID }}

      # Deploy Web only if apps/web was released
      - name: Deploy Web
        if: ${{ contains(fromJSON(needs.release.outputs.paths_released), 'apps/web') }}
        env:
          SVC_ID: d1823f35-d242-4f9e-bb83-b0f12f36d79a
        run: railway up -s ${{ env.SVC_ID }}

  sentry-release:
    needs: [release, deploy]
    if: ${{ needs.release.outputs.releases_created == 'true' && contains(fromJSON(needs.release.outputs.paths_released), 'apps/api') }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v6
        with:
          node-version-file: .nvmrc
          cache: npm

      - run: npm ci
      - run: npm run build:api

      - uses: getsentry/action-release@v3
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
        with:
          environment: production
          sourcemaps: './apps/api/dist'
